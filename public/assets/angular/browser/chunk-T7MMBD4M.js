import{n as k,q as o}from"./chunk-TS2YMWJE.js";import{$b as h,Q as s,U as n,Z as a,ac as l,l as u,ma as p}from"./chunk-B42WC262.js";var i=class r{setToken(e){localStorage.setItem("token",e)}getToken(){return localStorage.getItem("token")}removeToken(){localStorage.removeItem("token")}setTokenExpiry(e){localStorage.setItem("token_expiry",e.toString())}getTokenExpiry(){let e=localStorage.getItem("token_expiry");return e?+e:null}removeTokenExpiry(){localStorage.removeItem("token_expiry")}removeTokenAndTokenExpiry(){this.removeToken(),this.removeTokenExpiry()}hasToken(){return this.getToken()!==null}static \u0275fac=function(t){return new(t||r)};static \u0275prov=n({token:r,factory:r.\u0275fac,providedIn:"root"})};var c=class r{_authUser=p(void 0);_tokenExpiry=p(void 0);authUser=this._authUser.asReadonly();isLoggedIn=h(()=>this._authUser()!==void 0);tokenExpiry=this._tokenExpiry.asReadonly();http=a(k);tokenService=a(i);constructor(){let e=this.tokenService.getTokenExpiry();e&&this._tokenExpiry.set(e)}login(e){return this.http.post(`${o.apiUrl}/auth/login`,e).pipe(s(t=>this.handleLoginResponse(t)))}handleLoginResponse(e){this.setTokenAndTokenExpiry(e),this.loadUserFromToken()}setTokenAndTokenExpiry(e){this.tokenService.setToken(e.access_token);let t=this.calculateTokenExpiry(e.expires_in);this.tokenService.setTokenExpiry(t),this._tokenExpiry.set(t)}calculateTokenExpiry(e,t=Date.now()){return t+e*1e3}loadUserFromToken(){this.isLoggedIn()||this.tokenService.hasToken()&&this.http.get(`${o.apiUrl}/auth/me`).subscribe({next:e=>this._authUser.set(e),error:()=>console.warn("Error in the loadUserFromToken function")})}register(e){return this.http.post(`${o.apiUrl}/auth/register`,e)}logout(){return this._authUser.set(void 0),this.http.post(`${o.apiUrl}/auth/logout`,{}).pipe(s(()=>this.tokenService.removeTokenAndTokenExpiry()))}tokenRefreshEffect=l(()=>{let e=this._tokenExpiry();if(!e)return;if(this.isTokenExpired(e)){this.handleExpiredToken();return}let t=this.calculateRefreshDelay(e),f=this.scheduleTokenRefresh(t);return()=>clearTimeout(f)});isTokenExpired(e){return Date.now()>=e}handleExpiredToken(){console.warn("Token expired, logging out."),this.logout()}calculateRefreshDelay(e){return e-Date.now()-6e4}scheduleTokenRefresh(e){return setTimeout(()=>{this.refreshToken().subscribe({next:t=>this.setTokenAndTokenExpiry(t),error:()=>{console.warn("Token refresh failed unexpectedly, logging out."),this.logout()}})},e)}refreshToken(){return this.tokenService.hasToken()?this.http.post(`${o.apiUrl}/auth/refresh`,{}):u(()=>new Error("Cannot refresh token: No token present"))}static \u0275fac=function(t){return new(t||r)};static \u0275prov=n({token:r,factory:r.\u0275fac,providedIn:"root"})};export{i as a,c as b};
